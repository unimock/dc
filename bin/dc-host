#!/bin/bash

_ask()
{
  text="$1"
  echo "##################################################################"
  echo "#"
  echo "# ${text}. Type ENTER to start."
  echo "#"
  read ans
  return
}


HOST=$1
CMD=$2

if [ "$2" = "" ] ; then
  echo " usage: `basename $0` <host> upgrade|update|nrc|reboot|check|list|rm|up|ps|stop|start"
  if [ "$HOST" = "" ] ; then HOST="<host>" ; fi
  echo ""
  echo " host commands:"
  echo ""
  echo "    `basename $0` $HOST upgrade ...... do dist-upgrade"
  echo "    `basename $0` $HOST update ....... update docker-ce"
  echo "    `basename $0` $HOST nrc .......... number of running containers"
  echo "    `basename $0` $HOST reboot ....... reboot host"
  echo ""
  echo " service commands"
  echo ""
  echo "    `basename $0` $HOST list ......... list services on $HOST"
  echo "    `basename $0` $HOST check ........ check services on $HOST"
  echo "    `basename $0` $HOST stop|start ... start or stop all services on $HOST"
  echo "    `basename $0` $HOST rm|up ........ start or stop all services on $HOST"
  echo "    `basename $0` $HOST ps ........... show services on $HOST"
  echo ""
  exit 0
fi


if [ "$CMD" = "nrc" ] ; then
  dc -h $HOST ssh docker ps -q | wc -l 
  exit 0
fi

if [ "$CMD" = "update" ] ; then
  BCOUNT=$( dc -h $HOST ssh docker ps -q | wc -l )
  echo "#"
  echo "# Active containers on <$HOST> = $BCOUNT"
  echo "#"
  dc -h $HOST ssh apt-get update
  dc -h $HOST ssh apt-get -y install docker-ce
  sleep 3
  NCOUNT=$( dc -h $HOST ssh docker ps -q | wc -l )
  echo "#"
  echo "# Active containers on <$HOST> before=$BCOUNT now=$NCOUNT "
  echo "#"
  exit 0
fi

if [ "$CMD" = "upgrade" ] ; then
  BCOUNT=$( dc -h $HOST ssh docker ps -q | wc -l )
  echo "#"
  echo "# Active containers on <$HOST> = $BCOUNT"
  echo "#"
  dc-check hosts $HOST
  _ask "Start autoremove?"
  dc -h $HOST ssh apt-get -y autoremove
  _ask "Start apt-get update?"
  dc -h $HOST ssh apt-get update
  _ask "Start dist-uprade?"
  dc -h $HOST ssh apt-get -y dist-upgrade
  _ask "Check, if all containers are started!"
  NCOUNT=$( dc -h $HOST ssh docker ps -q | wc -l )
  echo "#"
  echo "# Active containers on <$HOST> before=$BCOUNT now=$NCOUNT "
  echo "#"
  _ask "Show running containers!"
  dc-check hosts $HOST
  _ask "reboot?"
  dc -h $HOST ssh init 6
  exit 0
fi
if [ "$CMD" = "check" ] ; then
  BCOUNT=$( dc -h $HOST ssh docker ps -q | wc -l )
  echo "#"
  echo "# Active containers on <$HOST> = $BCOUNT"
  echo "#"
  dc-check hosts $HOST
  exit 0
fi
if [ "$CMD" = "list" ] ; then
  dc-list -y services -h $HOST
  exit 0
fi
if [ "$CMD" = "rm" -o "$CMD" = "up" -o "$CMD" = "ps" -o "$CMD" = "stop" -o "$CMD" = "start"   ] ; then
  list=$( dc-list -y services -h $HOST )
  for i in $list ; do
    dc -h $HOST -c $i $CMD
  done
  exit 0
fi
if [ "$CMD" = "reboot"   ] ; then
  dc -h $HOST ssh "reboot ; exit"
  exit 0
fi
