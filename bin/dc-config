#!/bin/bash

. /opt/dc/etc/config

flist=$( find $MDE_DC_SERV_DIR/ -name dc-service.yml )

dname_list=" "

for i in $flist ; do
  dname=$( dc-yq '.service.name' $i )
  config_check=$( dc-yq '.service.config_check' $i )
  c_yaml=$( dc-yq '.service.control.file' $i )
  if [ "${c_yaml}" = "" ] ; then
    echo " ‚ùå fehler 1"
    exit 1
  fi
  c_yaml="`dirname $i`/${c_yaml}"
  cname=$(docker compose -f ${c_yaml} config |  dc-yq '.name')
  if [ "${dname}" != "${cname}" ] ; then
    echo " üí°(1) diff-name:  ${dname} != ${cname}   ($i  ${c_yaml})"
  fi
  if [[ "$dname_list" == *" $dname "* ]] ; then
    if [ "$config_check" != "false" ] ; then
      echo " üí°(2) not-uniqu:  $dname   ($i)"
    fi
  fi
  dname_list="$dname_list $dname "    

  #echo "config_check=$config_check"
  hosts=$( dc-yq '.service.hosts.[]' $i )
  if [ "$config_check" != "false" ] ; then
    vol_list=$(docker compose -f ${c_yaml} config | dc-yq '.services.*.volumes.[].source' | grep -v "^/etc/"  | grep -v "^/var/" | grep -v "^/lib/")
    for vol in $vol_list ; do
      if [[ "$vol" == "${MDE_DC_DOCKER_VOL}/Logs/$cname"         || \
            "$vol" == "${MDE_DC_DOCKER_VOL}/Logs/$cname/"*       || \
            "$vol" == "${MDE_DC_DOCKER_VOL}/Services/$cname"     || \
            "$vol" == "${MDE_DC_DOCKER_VOL}/Services/$cname/"*   || \
            "$vol" == "${MDE_DC_DOCKER_VOL}/Cache/$cname"        || \
            "$vol" == "${MDE_DC_DOCKER_VOL}/Cache/$cname/"*      || \
            "$vol" == "${MDE_DC_DOCKER_VOL}/Data/$cname"         || \
            "$vol" == "${MDE_DC_DOCKER_VOL}/Data/$cname/"*          \
         ]] ; then
        #echo "check if $vol exists on host"
        for h in $hosts ; do
          ssh $h ls -d $vol >/dev/null 2>&1
          if [ "$?" != "0" ] ; then
            echo " ‚ùå missing volume directory <$vol> on host <$h> ($i)"
          fi
        done
  
      else 
        echo " üí°(3) volconfig:  $vol ($cname)"
      fi
    done
  fi
  for h in $hosts ; do
  if [ ! -f /root/.ssh/dc/config.$h ] ; then
     echo " ‚ùå missing hos definition </root/.ssh/dc/config.$h>"
  fi
  done
done
exit 0

