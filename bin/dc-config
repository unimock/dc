#!/bin/bash

. /opt/dc/funcs/global


call_from="$(ps -o comm= $PPID)"
if [ "$call_from" == "dc" ] ; then
  IAM="dc config"
else
  IAM="dc-config"
fi

VARDIR="/opt/dc/var/cache"

project_dir="$VARDIR/projects"
hosts_dir="$VARDIR/hosts"
############################################################################################################################################
_config_refresh()
{
  config_change="0"
  mkdir -p $project_dir
  #
  # remove projects from cache, which do not exits in ${MDE_DC_SERV_DIR} anymore
  #
  list=$( find $project_dir -name "modified.*" )
  for i in $list ; do
    relPath=${i%/modified.*}
    relPath=${relPath#${project_dir}/}
    if [ -f $MDE_DC_SERV_DIR/${relPath}/${MDE_DC_YAML_FILE} ] ; then
      continue
    else
      echo "remove $project_dir/${relPath}"
      rm -rf $project_dir/${relPath}
      config_change="1"
    fi
  done
  #
  # check for changed hosts configurations
  #
  last=$( find /root/.ssh/dc/config  -maxdepth 1 -name "*.yml" -printf "%TF_%TT %p\n" | awk '{if ($0>max) max = $0} END{print max}'   )
  stamp=${last% *}
  if [ ! -f ${hosts_dir}/modified.${stamp} ] ; then
    rm -rf ${hosts_dir}
    mkdir ${hosts_dir}
    echo "$last" | awk '{ print $2 }' > ${hosts_dir}/modified.${stamp}
    list=$( find /root/.ssh/dc/config -name "*.yml" )
    echo "hosts:" > ${hosts_dir}/hosts.yml
    for i in $list ; do
      name=`basename $i`
      name=${name%.yml}
      sed "s|^host:|${name}:|g" $i | sed "s|^|  |g" | grep -o '^[^#]*' | sed '/^[[:space:]]*$/d' >> ${hosts_dir}/hosts.yml
    done
    config_change="1"
  fi
  #
  # check for changed project configurations
  #
  list=$( find $MDE_DC_SERV_DIR -name ${MDE_DC_YAML_FILE} )
  for i in $list ; do
    relPath=${i%/${MDE_DC_YAML_FILE}}
    relPath=${relPath#$MDE_DC_SERV_DIR/}
    VAR="${project_dir}/${i#${MDE_DC_SERV_DIR}/}"
    DIR="${i%/${MDE_DC_YAML_FILE}}"
    last=$( find $MDE_DC_SERV_DIR/${relPath}  -maxdepth 1 -type f -printf "%TF_%TT %p\n" | awk '{if ($0>max) max = $0} END{print max}'   )
    stamp=${last% *}
    #echo "$last"
    if [ -f ${project_dir}/${relPath}/modified.${stamp} ] ; then
      continue
    else
      rm -rf ${project_dir}/${relPath}
      mkdir -p ${project_dir}/${relPath}
      echo "$last" | awk '{ print $2 }' > ${project_dir}/${relPath}/modified.${stamp}
      compose_yml=$(dc-yq '.project.control.file' $i)
      echo "rebuild dc project for $i"
      cp $i ${project_dir}/${relPath}/
      docker compose -f $MDE_DC_SERV_DIR/${relPath}/${compose_yml} config > ${project_dir}/${relPath}/compose.yml
      # overrule project name, if host is mailcowdockerized
      project_name=$(dc-yq '.project.overrule_compose_name'  $i)
      if [ "$project_name" != "null" -a "$project_name" != "" ] ; then
        dc-yq -i '.name = "'$project_name'"' ${project_dir}/${relPath}/compose.yml
      fi
      config_change="1"
    fi
  done

  if [ "$config_change" = "1" ] ; then
    mkdir -p `dirname ${MDE_DC_YAML}`
    echo "re-create: ${MDE_DC_YAML}"
    cp $hosts_dir/hosts.yml ${MDE_DC_YAML}
    #
    # projects
    #
    echo "projects:"                                                              >> ${MDE_DC_YAML}
    list=$( find $project_dir -name "modified.*" )
    for i in $list ; do
      relPath=${i%/modified.*}
      relPath=${relPath#${project_dir}/}
      compose_yml=$(dc-yq '.project.control.file' $project_dir/${relPath}/${MDE_DC_YAML_FILE})
      compose_project=$(dc-yq '.name' $project_dir/${relPath}/compose.yml)
      echo "  ${compose_project}:"                                                >> ${MDE_DC_YAML}
      echo "    project_dir: $MDE_DC_SERV_DIR/${relPath}"                         >> ${MDE_DC_YAML}
      echo "    dc_yml: $MDE_DC_SERV_DIR/${relPath}/${MDE_DC_YAML_FILE}"          >> ${MDE_DC_YAML}
      echo "    compose_yml: $MDE_DC_SERV_DIR/${relPath}/${compose_yml}"          >> ${MDE_DC_YAML}
      #                                         remove comments  remove empty lines        remove version       rename service key to dc    indent
      cat $project_dir/${relPath}/${MDE_DC_YAML_FILE} | grep -o '^[^#]*' | sed '/^[[:space:]]*$/d' |sed -e "/^version:/d" -e "s/^project:/dc:/g" -e "s/^/    /g" >> ${MDE_DC_YAML}
      echo "    compose:"                                                         >> ${MDE_DC_YAML}
      cat $project_dir/${relPath}/compose.yml | sed -e "s/^/      /g"             >> ${MDE_DC_YAML}
    done
  fi
}

############################################################################################################################################
# magic main
############################################################################################################################################
if [ "$1" = "" ] ; then
  echo ""
  echo "usage: $IAM ..."
  echo ""
  echo "# common config commands:"
  echo ""
  echo "$IAM show         # show dc configuration"
  echo "$IAM refresh      # refresh dc config environment (${MDE_DC_YAML})"
  echo "$IAM rebuild      # rebuild dc config environment (${MDE_DC_YAML})"
  echo ""
  echo "# create/delete a sample project:"
  echo "" 
  echo "#$IAM create project <name>       <host> <main_service> <project_dir>"
  echo "$IAM  create project test-project apps0  filebrowser ${MDE_DC_SERV_DIR}/test-project"
  echo "$IAM  delete project test-project"
  echo ""
  echo "# create/delete a host definition"
  echo ""
  echo "#$IAM create host    <host>     [<hostname_or_ip]"
  echo "$IAM  create host    test-host  localhost"
  echo "$IAM  delete host    test-host"
  echo ""
  exit 0
fi

CMD="$1"
shift

######################################################################################################################
if [ "$CMD" = "rebuild" ] ; then
  rm -rf $VARDIR
  _config_refresh
  exit $?
fi

######################################################################################################################
if [ "$CMD" = "refresh" ] ; then
   _config_refresh
  exit $?
fi

######################################################################################################################
if [ "$CMD" = "create" -o "$CMD" = "delete" ] ; then
  TYP="$1"
  shift
  if [ "$TYP" = "project" ] ; then
    project_name="$1"    # must be unique
    project_dir=$( dc-yq '.projects.'$project_name'.project_dir'  ${MDE_DC_YAML} )
    if [ "$CMD" = "delete" ] ; then
      echo "################################################################################"
      echo "# delete project <$project_name> definition"
      echo "################################################################################"
      if [ "$project_dir" = "null" ] ; then
        echo "error: project <$project_name> did not exist!"
        exit 1
      fi
      project_hosts=$( dc-yq '.projects.'$project_name'.dc.home.[].host' ${MDE_DC_YAML} )
      for i in $project_hosts ; do
        nrc=$(dc-host -p $project_name -h $i $host nrc)
        found=0
        if [ "$nrc" != "0" ] ; then
          echo " $nrc containers still running on <$i> for this project"
          found=1
        fi
      done
      if [ "$found" = "1" ] ; then
        echo "error: do: dc -p ..."
        exit 1
      fi
      echo "TBD: check volumes of project on target host"
      rm -rvf $project_dir
      exit 0
    elif [ "$CMD" = "create" ] ; then
      echo "################################################################################"
      echo "# create project <$project_name>"
      echo "################################################################################"
      host="$2"
      if [ "$(dc-yq '.hosts.'$host'.state' ${MDE_DC_YAML})" = "null" ] ; then
        echo "error: host <$host> did not exist!"
        exit 1
      fi
      if [ "$project_dir" != "null" ] ;then
        echo "error: project <$project_name> already exists exists!"     
        exit 1
      fi
      main_service="$3"    # keep it simple, like: git,...
      conf_dir="$4"
      traefik_net="traefik_default"
      image="filebrowser/filebrowser:v2.25.0"
      if [ -d ${conf_dir} ] ; then
        echo "error: ${conf_dir} exists!"
        exit 1
      fi
      mkdir -p ${conf_dir}
      echo "${conf_dir} created"
      cp -r /opt/dc/templates/create/project/.   ${conf_dir}/
      flist=$( find  ${conf_dir} -type f)
      for i in $flist ; do
        sed -i "s|<project_name>|${project_name}|g"   $i
        sed -i "s|<main_service>|${main_service}|g"   $i
        sed -i "s|<host>|${host}|g"                   $i
        sed -i "s|<image>|${image}|g"                 $i
        sed -i "s|<traefik_net>|${traefik_net}|g"     $i
        echo "$i"
      done
      cd ${conf_dir}
      dc config refresh
      dc up
      dc login ls /
      dc rm
      exit 0
    fi
  fi
  if [ "$TYP" = "host" ] ; then
    name="$1"
    if [ "$name" = "" ] ; then
      echo "error: invalid host name <$name> given!"
      exit 1
    fi
    exists=$( dc-yq '.hosts.'$name'.state' ${MDE_DC_YAML} )
    if [ "$CMD" = "delete" ] ; then
      echo "################################################################################"
      echo "# delete host <$name> definition"
      echo "################################################################################"
      if [ "$exists" = "null" ] ; then
         echo "error: host <$name> did not exist!"
         exit 1
      fi
      if [ "$( dc-list projects -h $name)" != "" ] ; then
        echo "error: the following projects still defined for host <$name> :"
        dc-list projects -h $name | sed "s|^| - |g" 
        exit 1
      fi
      echo "TBD in $0 : do not allow, if hcloud server is assigned an running!"
      rm -fv ${MDE_DC_DIR}/.ssh/dc/config/${name}.*
      exit 0
    fi
    if [ "$CMD" = "create" ] ; then
      echo "################################################################################"
      echo "# create host <${name}> definition"
      echo "################################################################################"
      if [ -f "${MDE_DC_DIR}/.ssh/dc/config/${name}.yml" ] ; then
        echo "error: <${MDE_DC_DIR}/.ssh/dc/config/${name}.yml> exists!"
        echo "remove it with:  rm -vf ${MDE_DC_DIR}/.ssh/dc/config/${name}.*" 
        exit 1
      fi
      cp  /opt/dc/templates/create/host/host.config ${MDE_DC_DIR}/.ssh/dc/config/${name}.ssh
      cp  /opt/dc/templates/create/host/host.yml    ${MDE_DC_DIR}/.ssh/dc/config/${name}.yml
      flist="${MDE_DC_DIR}/.ssh/dc/config/${name}.ssh ${MDE_DC_DIR}/.ssh/dc/config/${name}.yml"
      hostname="$name"
      if [ "$2" != "" ] ; then
        hostname="$2"
      fi
      for i in $flist ; do
          sed -i "s|<name>|${name}|g"   $i
          sed -i "s|<hostname_or_ip>|${hostname}|g"   $i
          echo "created '$i'"
      done   
    fi
    exit 0
  fi
fi

if [ "$CMD" = "yq" -o  "$CMD" = "edit"  ] ; then
  if [[ "$1" == "" || ( "$1" != "host" &&  "$1" != "project" ) ]] ; then
    echo "error: unkown type given. Use host or project!"
    exit 1
  fi
  TYP="$1" ; shift
  if [ "$1" == "" ] ; then
    echo "error: no $TYP name given!"
    exit 1
  fi
  name="$1" ; shift
  rest=$*
  #if [ "$TYP" = "host" ] ; then
  #else
  #fi
  echo "conig_file="
  exit $?  
fi

if [ "$CMD" = "show"  ] ; then
  dc-yq ${MDE_DC_YAML}
fi  

if [ "$CMD" = "check" ] ; then
  echo " ‚úÖ last modification of ${MDE_DC_YAML} <$(date -r ${MDE_DC_YAML} "+%Y-%m-%d %H:%M:%S")>"
  hosts=$( dc-yq  '.projects.*.dc.home.[].host'   ${MDE_DC_YAML}  | sort | uniq)
  for h in $hosts ; do
    res=$(  dc-yq '.hosts.'$h'.state' $MDE_DC_YAML ) 
    if [ "$res" = "null" ] ; then
      echo " ‚ùå missing host definition \".hosts.$h.state:\" in <$MDE_DC_YAM>"
    elif [ "$res" != "active" ] ; then
      echo " üí° \".hosts.$h.state:\" != active"
    fi
  done

  projects=$( dc-yq '(.projects.* | path )  [-1]'  ${MDE_DC_YAML} | sort )
  for p in $projects ; do
    ignore_vol_check=$( dc-yq '.projects.'$p'.dc.ignore_volume_check' ${MDE_DC_YAML} )
    p_on_hosts=( `dc-yq '.projects.'$p'.dc.home.[].host' ${MDE_DC_YAML}` )   # Array
    s_on_hosts=( `dc-yq '.projects.'$p'.dc.home.[].state' ${MDE_DC_YAML}` )  # Array
    cfg=$( dc-yq '.projects.'$p'.compose_yml' ${MDE_DC_YAML} )
    #
    # check for not unique project names
    #
    anz=$( dc-yq '.projects' ${MDE_DC_YAML} | grep "^${p}:"  | wc -l)
    if [ "$anz" != "1" ] ; then
      echo " ‚ùå project name [$p] not unique"
    fi
    #
    # check if project name overrules (mailcowdockerized)
    #
    project_name=$( dc-yq '.projects.'$p'.dc.project_name' ${MDE_DC_YAML} )
    if [ "$project_name" != "null" -a "$project_name" != "" ] ; then
      echo " üí° [$p] project name overrule <project_name: $project_name> in $cfg"
    fi

    vol_list=$(dc-yq '.projects.'$p'.compose.services.*.volumes.[].source' ${MDE_DC_YAML} | grep -v "^/etc/"  | grep -v "^/var/" | grep -v "^/lib/" | sort | uniq )

    for h in "${!p_on_hosts[@]}"; do
      if [ "${s_on_hosts[$h]}" != "active" ] ; then
         echo " üí° [$p] home.[$h].state: ${s_on_hosts[$h]} != active in $cfg"
      fi
      ssh ${p_on_hosts[$h]} exit 0 >/dev/null 2>&1
      if [ "$?" != "0" ] ; then
        echo " ‚ùå [$p] error host <${p_on_hosts[$h]}> not reachable, so volume check not possible"
      else
        # do volume check
        if [ "$ignore_vol_check" != "true" ] ; then
          for vol in $vol_list ; do
            #echo "  $vol" 
            if [[ "$vol" == "${MDE_DC_DOCKER_VOL}/Logs/$p"         || \
                  "$vol" == "${MDE_DC_DOCKER_VOL}/Logs/$p/"*       || \
                  "$vol" == "${MDE_DC_DOCKER_VOL}/Services/$p"     || \
                  "$vol" == "${MDE_DC_DOCKER_VOL}/Services/$p/"*   || \
                  "$vol" == "${MDE_DC_DOCKER_VOL}/Cache/$p"        || \
                  "$vol" == "${MDE_DC_DOCKER_VOL}/Cache/$p/"*      || \
                  "$vol" == "${MDE_DC_DOCKER_VOL}/Data/$p"         || \
                  "$vol" == "${MDE_DC_DOCKER_VOL}/Data/$p/"*          \
               ]] ; then
              # check if $vol exists on host
              ssh ${p_on_hosts[$h]} ls -d $vol >/dev/null 2>&1
              if [ "$?" != "0" ] ; then
                echo " ‚ùå [$p] missing volume directory <$vol> on host <${p_on_hosts[$h]}>"
              fi
            else
              echo " üí° [$p] volume config <$vol> in $cfg" 
            fi
          done
        else
          echo " üí° [$p] ignore volume check <ignore_volume_check: true> in $cfg"
        fi
      fi
    done
  done
fi 
exit 0

