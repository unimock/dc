#!/bin/bash

. /opt/dc/etc/config
. /opt/dc/funcs/config-refresh

print_yml="0"

CURROPT=""
while [ "$#" -gt 0 ]; do
  case "$1" in
    -y) print_yml="1" ; shift 1 ;;
    -s) service="$2" ; shift 2 ;;
    -h) on_host="$2" ; shift 2 ;;
    -g) group="$2"   ; shift 2 ;;
    *)  CURROPT="$CURROPT \"$1\"" ; shift 1 ;;
  esac
done
eval set -- $CURROPT

CMD="$1"

if [ "$CMD" = "" ] ; then
  echo ""
  echo " usage: `basename $0` [<optinons>] <command>"
  echo "   options:"
  echo""
  echo "       -y ................... print yml-config-file instaed of name"
  echo "       -g ................... print services for a group"
  echo "       -h ................... print services defined for a host"
  echo ""
  echo "    commands:"
  echo ""
  echo "       hosts all ............ list all hosts, which are defined in .ssh/dc/config/*.yml as state=active|standby"
  echo "       hosts dc ............. list all hosts, which are defined in .ssh/dc/config/*.yml and groups=dc (dc host"
  echo "       hosts used ........... list all hosts, which are used in services"
  echo "       services [-h|-g] ..... list services"
  echo ""
  exit 0
fi

if [ "$CMD" = "hosts" ] ; then
  if [ "$2" = "" -o  "$2" = "all" ] ; then
    dc-ls --short | sort
  elif [ "$2" = "dc" ] ; then
    dc-ls --group=dc --short | sort
  elif [ "$2" = "used" ] ; then
    dc-yq '.projects.*.dc.home.[].host'   ${MDE_DC_YAML} | sort | uniq
  fi
  exit 0
fi

if [ "$CMD" = "services" ] ; then
  shift
  if [ "$on_host" != "" ] ; then
    project_list=$( dc-yq  '(( .projects.* | select(.dc.home.[].host == "'$on_host'" ) | path ) [-1] )' ${MDE_DC_YAML} )
  else
    project_list=$(dc-yq '(.projects.[] | path ) [-1]'   ${MDE_DC_YAML})
  fi
  for p in $project_list ; do
    if [ "$service" != "" -a "$service" != "$p" ] ; then
      continue
    fi
    if [ "$group" != "" ] ; then
      groups=$( dc-yq '.projects.'$p'.dc.group[]'  ${MDE_DC_YAML}  )
      found_in_group="0"
      for g in $groups ; do
        if [ "$g" = "$group" ] ; then
          found_in_group="1"
        fi
      done
      if [ "$found_in_group" = "0" ] ; then
        continue
      fi
    fi
    if [ "$print_yml" = "1" ] ; then
      cfg=$( dc-yq '.projects.'$p'.dc_yml' ${MDE_DC_YAML} )
      echo "$cfg"
    else
      echo "$p"
    fi
  done
fi
exit 0

