#!/bin/bash

. /opt/dc/etc/config
. /opt/dc/funcs/config-refresh

print_yml="0"

CURROPT=""
while [ "$#" -gt 0 ]; do
  case "$1" in
    -y) print_yml="1" ; shift 1 ;;
    -s) service="$2" ; shift 2 ;;
    -h) on_host="$2" ; shift 2 ;;
    -g) group="$2"   ; shift 2 ;;
    *)  CURROPT="$CURROPT \"$1\"" ; shift 1 ;;
  esac
done
eval set -- $CURROPT

CMD="$1"

if [ "$CMD" = "" ] ; then
  echo ""
  echo " usage: `basename $0` [<optinons>] <command>"
  echo "   options:"
  echo""
  echo "       -y ................... print yml-config-file instaed of name"
  echo "       -g ................... print services for a group"
  echo "       -h ................... print services defined for a host"
  echo ""
  echo "    commands:"
  echo ""
  echo "       active_hosts ......... list all hosts, which are configured as active in ndc-host.yml"
  echo "       used_hosts ........... list all hosts, which are used in services"
  echo "       services [-h|-g] ..... list services"
  exit 0
fi

if [ "$CMD" = "active_hosts" ] ; then
  dc ls --group=d --short
  exit 0
fi

if [ "$CMD" = "used_hosts" ] ; then
  dc-yq '.projects.*.dc.hosts[]'   /var/dc/dc.yml | sort | uniq
fi

if [ "$CMD" = "services" ] ; then
  shift
  if [ "$on_host" != "" ] ; then
    project_list=$( dc-yq  '(( .projects.* | select(.dc.hosts[] == "'$on_host'" ) | path ) [-1] )' /var/dc/dc.yml )
  else
    project_list=$(dc-yq '(.projects.[] | path ) [-1]'   /var/dc/dc.yml)
  fi
  for p in $project_list ; do
    if [ "$service" != "" -a "$service" != "$p" ] ; then
      continue
    fi
    if [ "$group" != "" ] ; then
      groups=$( dc-yq '.projects.'$p'.dc.group[]'  /var/dc/dc.yml  )
      found_in_group="0"
      for g in $groups ; do
        if [ "$g" = "$group" ] ; then
          found_in_group="1"
        fi
      done
      if [ "$found_in_group" = "0" ] ; then
        continue
      fi
    fi
    if [ "$print_yml" = "1" ] ; then
      cfg=$( dc-yq '.projects.'$p'.dc_yml' /var/dc/dc.yml )
      echo "$cfg"
    else
      echo "$p"
    fi
  done
fi
exit 0

