#!/bin/bash

APT_PACKAGES="sshfs libnet-ssleay-perl swaks"

IAM="dc install"
if [ "$(ps -o comm= $PPID)" = "dc" ] ; then
  IAM="dc install"
fi

_help() {
  echo ""
  echo " usage: $IAM  base|.."
  echo ""
  echo " common config commands:"
  echo ""
  echo "$IAM     # dc managment basi installation"
  echo ""
  echo ""
}

#if [ "$1" = "" ] ; then
#  _help
#  exit 0
#fi

  if [ ! -d /opt/dc ] ; then
    sudo git clone https://github.com/unimock/dc.git /opt/dc
  #else
  #  (cd /opt/dc && git pull)
  fi
  if [ ! -f $HOME/.dc/etc/config ] ; then
    echo ""
    echo "# Main configuration file <$HOME/.dc/etc/config> does not exists."
    echo "# Default configuration from template directory was activated."
    echo "# You can change it and then re-call dc-install"
    echo ""
    mkdir -p $HOME/.dc/etc
    cp /opt/dc/templates/config $HOME/.dc/etc
    exit 0
  fi
  source $HOME/.dc/etc/config
  echo "$IAM: create directories <${MDE_DC_PROJ_DIR}> <${MDE_DC_HOST_DIR}>..."
  mkdir -vp ${MDE_DC_PROJ_DIR} ${MDE_DC_HOST_DIR}
  if [ ! -f ${MDE_DC_HOST_DIR}/id_ed25519 ] ; then
    echo "$IAM: create dc ssh keys in <${MDE_DC_HOST_DIR}/>..."
    ssh-keygen -q -N "" -o -a 100 -t ed25519 -f ${MDE_DC_HOST_DIR}/id_ed25519 -C 'dc'
  fi
  # create dc profile file
  echo "$IAM: create </etc/profile.d/dc-profile.sh>..."
  printf 'PATH=/opt/dc/bin:$PATH\n' | sudo tee /etc/profile.d/dc-profile.sh >/dev/null
  #printf 'source /opt/dc/etc/config\nexport PATH=/opt/dc/bin:$PATH\n' | sudo tee /etc/profile.d/dc-profile.sh >/dev/null
  sudo chmod a+x /etc/profile.d/dc-profile.sh

  # modify other files
  FI=${HOME}/.bashrc
  echo "$IAM: modify <$FI>..."
  touch $FI
  sed -i '/#dc-install/d' $FI        
  sed -i '1 i\source ${HOME}/.dc/etc/config #dc-install'     $FI
  sed -i '1 i\export PATH=/opt/dc/bin:$PATH #dc-install' $FI
  FI=${HOME}/.bash_aliases
  echo "$IAM: modify <$FI>..."
  touch $FI
  sed -i '/#dc-install/d' $FI
  echo 'source <(/opt/dc/bin/dc completion) #dc-install' >> $FI
  FI=${HOME}/.ssh/config
  echo "$IAM: modify <$FI>..."
  touch $FI
  sed -i '/#dc-install/d' $FI
  echo "Include ${HOME}/.dc/var/ssh/config/* #dc-install" >> $FI

  # install additional apt packages
  for p in ${APT_PACKAGES} ; do
    dpkg -s $p >/dev/null 2>&1
    if [ "$?" != "0" ] ; then
      sudo apt-get install -y $p
    fi
  done

  mkdir -p ${MDE_DC_CONFIG_DIR}
  # establish dc-crontab
  if [ ! -f ${MDE_DC_CONFIG_DIR}/crontab ] ; then
    cp /opt/dc/templates/create/config/crontab ${MDE_DC_CONFIG_DIR}
  fi
  if [ ! -f /etc/cron.d/dc-crontab ] ; then
    sudo ln -s ${MDE_DC_CONFIG_DIR}/crontab /etc/cron.d/dc-crontab
    echo "$IAM: create <${MDE_DC_CONFIG_DIR}/crontab>"
  fi

  # other yml configs
  list=$( find /opt/dc/templates/create/config -name "*.yml" )
  for i in $list ; do
    if [ ! -f ${MDE_DC_CONFIG_DIR}/`basename $i` ] ; then
      cp $i ${MDE_DC_CONFIG_DIR}
      echo "$IAM: create <${MDE_DC_CONFIG_DIR}/`basename $i`>"
    fi
  done      
  source ${HOME}/.bashrc
  dc-config rebuild

exit 0
