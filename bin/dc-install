#!/bin/bash

APT_PACKAGES="sshfs libnet-ssleay-perl swaks"

IAM="dc install"
if [ "$(ps -o comm= $PPID)" = "dc" ] ; then
  IAM="dc install"
fi

_help() {
  echo ""
  echo " usage: $IAM  base|.."
  echo ""
  echo " common config commands:"
  echo ""
  echo "$IAM     # dc managment basi installation"
  echo ""
  echo ""
}

#if [ "$1" = "" ] ; then
#  _help
#  exit 0
#fi

  if [ ! -d /opt/dc ] ; then
    git clone https://github.com/unimock/dc.git /opt/dc
  fi
  if [ ! -f /opt/dc/etc/config ] ; then
    echo ""
    echo "# Main configuration file </opt/dc/etc/config> does not exists."
    echo "# Default configuration from template directory was activated."
    echo "# You can change it and then re-call dc-install"
    echo ""
    mkdir -p /opt/dc/etc
    cp /opt/dc/templates/config /opt/dc/etc/config
    exit 0
  fi
  source /opt/dc/etc/config
  echo "$IAM: create directries <${MDE_DC_PROJ_DIR}> <${MDE_DC_HOST_DIR}>..."
  mkdir -vp ${MDE_DC_PROJ_DIR} ${MDE_DC_HOST_DIR}
  if [ ! -f /root/dc/hosts/id_ed25519 ] ; then
    echo "$IAM: create dc ssh keys in </root/dc/hosts/>..."
    ssh-keygen -q -N "" -o -a 100 -t ed25519 -f /root/dc/hosts/id_ed25519 -C 'dc'
  fi
  # create dc prfile file
  echo "$IAM: create </etc/profile.d/dc-profile.sh>..."
  echo 'source /opt/dc/etc/config'         >  /etc/profile.d/dc-profile.sh
  echo 'export PATH=/opt/dc/bin:$PATH'     >> /etc/profile.d/dc-profile.sh
  chmod a+x /etc/profile.d/dc-profile.sh

  # modify other files
  FI=/root/.bashrc
  echo "$IAM: modify <$FI>..."
  touch $FI
  sed -i '/#dc-install/d' $FI        
  sed -i '1 i\source /opt/dc/etc/config #dc-install'     $FI
  sed -i '1 i\export PATH=/opt/dc/bin:$PATH #dc-install' $FI
  FI=/root/.bash_aliases
  echo "$IAM: modify <$FI>..."
  touch $FI
  sed -i '/#dc-install/d' $FI
  echo 'source <(/opt/dc/bin/dc completion) #dc-install' >> $FI
  FI=/root/.ssh/config
  echo "$IAM: modify <$FI>..."
  touch $FI
  sed -i '/#dc-install/d' $FI
  echo 'Include /opt/dc/var/ssh/config/* #dc-install' >> $FI

  # install additional apt packages
  for p in ${APT_PACKAGES} ; do
    dpkg -s $p >/dev/null 2>&1
    if [ "$?" != "0" ] ; then
      apt-get install -y $p
    fi
  done

  mkdir -p ${MDE_DC_CONFIG_DIR}
  # establish dc-crontab
  if [ ! -f ${MDE_DC_CONFIG_DIR}/dc-crontab ] ; then
    cp /opt/dc/templates/create/config/dc-crontab ${MDE_DC_CONFIG_DIR}
  fi
  if [ ! -f /etc/cron.d/dc-crontab ] ; then
    ln -s ${MDE_DC_CONFIG_DIR}/dc-crontab /etc/cron.d/dc-crontab
    echo "$IAM: create <${MDE_DC_CONFIG_DIR}/dc-crontab>"
  fi

  # other yml configs
  list=$( find /opt/dc/templates/create/config -name "*.yml" )
  for i in $list ; do
    if [ ! -f ${MDE_DC_CONFIG_DIR}/`basename $i` ] ; then
      cp $i ${MDE_DC_CONFIG_DIR}
      echo "$IAM: create <${MDE_DC_CONFIG_DIR}/`basename $i`>"
    fi
  done      


exit 0
