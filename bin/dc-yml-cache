#!/bin/bash

. /opt/dc/etc/config


VARDIR="/var/cache/dc"


if [ "$1" = "rebuild" ] ; then
  rm -rf $VARDIR
fi

if [ "$1" = "refresh" -o "$1" = "rebuild" ] ; then
  config_change="0"
  mkdir -p $VARDIR

  list=$( find $VARDIR -name "modified.*" )
  for i in $list ; do
    relPath=${i%/modified.*}
    relPath=${relPath#${VARDIR}/}
    if [ -f $MDE_DC_SERV_DIR/${relPath}/dc-service.yml ] ; then
      continue
    else
      echo "remove $VARDIR/${relPath}"
      rm -rf $VARDIR/${relPath}
      config_change="1"
    fi
  done

  list=$( find $MDE_DC_SERV_DIR -name dc-service.yml )
  for i in $list ; do
    relPath=${i%/dc-service.yml}
    relPath=${relPath#$MDE_DC_SERV_DIR/}
    VAR="${VARDIR}/${i#${MDE_DC_SERV_DIR}/}"
    DIR="${i%/dc-service.yml}"
    last=$( find $MDE_DC_SERV_DIR/${relPath}  -maxdepth 1 -type f -printf "%TF_%TT %p\n" | awk '{if ($0>max) max = $0} END{print max}'   )
    stamp=${last% *}
    #echo "$last"
    if [ -f ${VARDIR}/${relPath}/modified.${stamp} ] ; then
      continue
    else
      #echo "create ${VARDIR}/${relPath}/modified.${stamp}"
      rm -rf ${VARDIR}/${relPath}
      mkdir -p ${VARDIR}/${relPath}
      echo "$last" | awk '{ print $2 }' > ${VARDIR}/${relPath}/modified.${stamp}
      compose_yml=$(dc-yq '.service.control.file' $i)
      cp $i ${VARDIR}/${relPath}/
      docker compose -f $MDE_DC_SERV_DIR/${relPath}/${compose_yml} config > ${VARDIR}/${relPath}/compose.yml
      config_change="1"
    fi
  done
  if [ "$config_change" = "1" ] ; then
    rm -f /var/dc/dc.yml
    list=$( find $VARDIR -name "modified.*" )
    for i in $list ; do
      relPath=${i%/modified.*}
      relPath=${relPath#${VARDIR}/}
      compose_yml=$(dc-yq '.service.control.file' $VARDIR/${relPath}/dc-service.yml)
      compose_project=$(dc-yq '.name' $VARDIR/${relPath}/compose.yml)
      echo "${compose_project}:"                                                >> /var/dc/dc.yml
      echo "  dc_yml: $MDE_DC_SERV_DIR/${relPath}/dc-service.yml"                >> /var/dc/dc.yml
      echo "  compose_yml: $MDE_DC_SERV_DIR/${relPath}/${compose_yml}"           >> /var/dc/dc.yml
      cat $VARDIR/${relPath}/dc-service.yml | sed -e "/^version:/d" -e "s/^service:/dc:/g" -e "s/^/  /g" >> /var/dc/dc.yml
      echo "  compose:"                                                         >> /var/dc/dc.yml
      cat $VARDIR/${relPath}/compose.yml | sed -e "s/^/    /g"                  >> /var/dc/dc.yml
    done
  fi
fi
exit 0

